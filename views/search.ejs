<%- include('./partials/Header.ejs') %>

  <main style="padding: var(--spacing-xl) 0; min-height: 80vh; background-color: var(--color-bg-primary);">
    <div class="container">

      <div
        style="margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">

        <div>
          <% if (cat){ %>
            <h2 style="font-size: 1.8rem; font-family: var(--font-heading);">
              <%= displayCategory %> <i class="ri-shopping-cart-2-line"
                  style="font-size: 1.5rem; color: var(--color-accent-primary);"></i>
            </h2>
            <% } %>
              <%if (gen) {%>
                <%if(gender==='Men' ){%>
                  <h2 style="font-size: 1.8rem; font-family: var(--font-heading);">
                    Men's Collection <i class="ri-men-line"
                      style="font-size: 1.5rem; color: var(--color-accent-primary);"></i>
                  </h2>
                  <%}%>
                    <%if(gender==='Women' ){%>
                      <h2 style="font-size: 1.8rem; font-family: var(--font-heading);">
                        Women's Collection <i class="ri-women-line"
                          style="font-size: 1.5rem; color: var(--color-accent-primary);"></i>
                      </h2>
                      <% }%>
                        <%}%>
                          <% if (!cat && !gen) { %>
                            <h2 style="font-size: 1.8rem; font-family: var(--font-heading);">Search Results</h2>
                            <% } %>
        </div>

        <!-- Filter Section -->
        <% if (cat) { %>
          <form action="/clothings/<%= category%>" method="get"
            style="display: flex; align-items: center; gap: 0.5rem;">
            <label for="gender-filter" style="font-size: 0.9rem; font-weight: 500;">Filter by Gender:</label>
            <select id="gender-filter" name="gender"
              style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 4px; font-size: 0.9rem;">
              <option value="all">All</option>
              <option value="men">Men</option>
              <option value="women">Women</option>
            </select>
            <button type="submit" class="btn btn-primary"
              style="padding: 0.5rem 1rem; font-size: 0.9rem;">Filter</button>
          </form>
          <% } %>

      </div>

      <!-- Product Listings -->
      <% if (!selectedProducts || selectedProducts.length===0) { %>
        <div style="text-align: center; padding: 4rem; color: var(--color-text-secondary);">
          <i class="ri-search-2-line" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
          <p style="font-size: 1.1rem;">No products found matching your criteria.</p>
          <a href="/" class="btn btn-primary" style="margin-top: 1rem;">Browse All Products</a>
        </div>
        <% } else { %>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 2rem;">
            <% selectedProducts.forEach((fit)=> { %>
              <div class="product-card"
                style="background: white; border-radius: var(--border-radius-md); overflow: hidden; box-shadow: var(--shadow-sm); transition: transform 0.2s, box-shadow 0.2s; position: relative;">

                <!-- Image -->
                <div style="position: relative; height: 350px; overflow: hidden; background: #f0f0f0;">
                  <a href="/products/<%= fit._id %>" style="display: block; width: 100%; height: 100%;">
                    <img src="<%= fit.mainImage %>" alt="<%= fit.title %>"
                      style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s;">
                  </a>
                </div>

                <!-- Content -->
                <div style="padding: 1rem;">
                  <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; margin: 0;">
                      <a href="/products/<%= fit._id %>"
                        style="color: var(--color-text-primary); text-decoration: none;">
                        <%= fit.title %>
                      </a>
                    </h3>
                    <span style="font-size: 0.95rem; font-weight: 600; color: var(--color-accent-primary);">PKR <%=
                        fit.price %></span>
                  </div>

                  <div style="display: flex; gap: 5px; margin-bottom: 1rem;">
                    <% if (fit.color && Array.isArray(fit.color)) { %>
                      <% for (let j=0; j < fit.color.length; j++) { %>
                        <span
                          style="width: 12px; height: 12px; border-radius: 50%; background-color: <%= fit.color[j] %>; border: 1px solid #ddd; display: inline-block;"></span>
                        <% } %>
                          <% } %>
                  </div>

                  <button class="btn btn-outline add-to-cart-btn" data-id="<%= fit._id%>"
                    style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="ri-shopping-cart-line"></i> Add to Cart
                  </button>
                </div>
              </div>
              <% }) %>
          </div>
          <% } %>

    </div>
  </main>

  <%- include('./partials/Footer.ejs') %>

    <script>
      document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const id = btn.dataset.id;
          try {
            const response = await fetch(`/add-to-cart/${id}`); // Assuming GET based on old code, typically should be POST or handled via simpler link if simple
            // Actually the old code used addToCart() function in index.js which did an ajax call. 
            // Let's assume standard link navigation for simplicity OR replicate the ajax if I knew it.
            // The old code had: <button data-fitId="<%= fit._id%>" ...
            // And script: addToCart(). 
            // Since I don't want to rely on the old index.js which might be broken/removed, I'll use a direct link logic or simple fetch.
            // The route is `router.get('/add-to-cart/:id', ...)` based on standard practices in this app (implied).
            // Let's just redirect for now to be safe, or fetch and show toast.
            window.location.href = `/add-to-cart/${id}`;
          } catch (err) {
            console.error("Failed to add to cart");
          }
        });
      });
    </script>

    <style>
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
      }

      .product-card:hover img {
        transform: scale(1.05);
      }
    </style>